<!DOCTYPE html>
<html>
<head>
    <title>Trello Power-Up</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
    <script>
        TrelloPowerUp.initialize({
            'card-buttons': function(t, options) {
                return [{
                    icon: 'https://connjer78.github.io/BWPR/assets/rocketship.PNG',
                    text: 'Sprint This Card's Labels',
                    callback: function(t) {
                        // Show alert to the user
                        t.alert({
                            message: 'Creating Sprint Cards',
                            duration: 3
                        });

                        // Start the card creation process
                        t.card('name', function(originalCardName) { // Get original card name
                            t.card('labels', function(labels) { // Get original card labels
                                // Get all boards for the user
                                t.get('member', 'boards', { filter: 'open' }, function(boards) {
                                    console.log("Boards:", boards); // Log the boards array

                                    // Find the first board whose name includes "Sprint"
                                    const sprintBoard = boards.find(board => board.name.includes('Sprint'));

                                    if (!sprintBoard) {
                                        console.error("No board containing 'Sprint' found.");
                                        return;
                                    }

                                    // Fetch the lists on the found "Sprint" board
                                    t.get(`board/${sprintBoard.id}/lists`, { filter: 'open' }, function(lists) {
                                        console.log("Lists on Sprint Board:", lists); // Log the lists array

                                        // Ensure there are lists before accessing
                                        if (lists.length === 0) {
                                            console.error("No lists found on the Sprint board.");
                                            return;
                                        }

                                        const targetListId = lists[0].id; // Use the ID of the first list
                                        const cardPromises = [];

                                        // Check if there are labels
                                        if (labels.length === 0) {
                                            // If no labels, create a new card with the original card's name
                                            const cardData = {
                                                name: originalCardName, // Card name is the same as the original card
                                                idList: targetListId, // Use the first list's ID on the "Sprint" board
                                            };
                                            console.log("Creating card with no labels:", cardData);
                                            cardPromises.push(
                                                t.request({
                                                    url: 'cards',
                                                    method: 'POST',
                                                    body: JSON.stringify(cardData),
                                                    headers: {
                                                        'Content-Type': 'application/json'
                                                    }
                                                }, function(response) {
                                                    console.log("Created card with no labels:", response);
                                                })
                                            );
                                        } else {
                                            // If there are labels, create a new card for each label
                                            labels.forEach(label => {
                                                const newCardName = `${originalCardName} ${label.name}`.trim();
                                                const cardData = {
                                                    name: newCardName,
                                                    idList: targetListId, // Use the first list's ID on the "Sprint" board
                                                };
                                                console.log("Creating card with label:", cardData);
                                                cardPromises.push(
                                                    t.request({
                                                        url: 'cards',
                                                        method: 'POST',
                                                        body: JSON.stringify(cardData),
                                                        headers: {
                                                            'Content-Type': 'application/json'
                                                        }
                                                    }, function(response) {
                                                        console.log("Created card with label:", response);
                                                    })
                                                );
                                            });
                                        }

                                        // Handle responses from card creation
                                        cardPromises.forEach((promise) => {
                                            promise.then(function(response) {
                                                console.log("Card created successfully:", response);
                                            }).catch(function(error) {
                                                console.error("Error creating sprint cards:", error);
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    }
                }];
            }
        });
    </script>
</body>
</html>
