<!DOCTYPE html>
<html>
<head>
    <title>Trello Power-Up</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        // Initialize the Trello Power-Up
        TrelloPowerUp.initialize({
            'card-buttons': function(t, options) {
                return [{
                    text: 'Sprint It!', // Text displayed on the button
                    callback: function(t, options) {
                        console.log("Button clicked!"); // Log button click for debugging
                        
                        // Fetch the ID of the current board
                        return t.get('card', 'idBoard')
                            .then(function(boardId) { // When the board ID is retrieved
                                // Fetch the labels from the card
                                return t.get('card', 'shared', 'labels')
                                    .then(function(labels) { // When the labels are retrieved
                                        // For each label, find the corresponding template card
                                        labels.forEach(function(label) {
                                            findTemplateCard(boardId, label).then(function(templateCard) { // Find the template card by label
                                                if (templateCard) {
                                                    createSprintCard(boardId, templateCard); // Create sprint card from template
                                                } else {
                                                    console.error('Template not found for label:', label.name); // Log if no template found
                                                }
                                            });
                                        });
                                    });
                            });
                    }
                }];
            }
        });
        
        // Function to find the template card by label
        function findTemplateCard(boardId, label) {
            // Fetch all cards from the current board
            return t.get('board', 'all')
                .then(function(boardData) {
                    var cards = boardData.cards; // Get the list of cards
                    // Find the card that has the same name as the label
                    return cards.find(card => card.name === label.name); // Return the matching template card
                });
        }
        
        // Function to create a new card in the board from a template card
        function createSprintCard(boardId, templateCard) {
            // Define the new card data using the template card's details
            var cardData = {
                name: templateCard.name, // The name of the template card as the new card title
                desc: templateCard.desc, // Copy the description from the template
                labels: templateCard.labels.map(lbl => lbl.id), // Assign the template's label IDs to the new card
                idList: '66e9ca5e0e5d1635fdb8388d' // Replace with your actual list ID
            };
        
            // Use Trello API to create a new card
            t.post('cards', cardData)
                .then(function(response) {
                    // Log successful card creation
                    console.log('Card created:', response);
                })
                .catch(function(error) {
                    // Handle any errors
                    console.error('Error creating card:', error);
                });
        }
    </script>
</head>
<body>
    <h1>Your Trello Power-Up</h1>
</body>
</html>
