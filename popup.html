<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <style>
    body { 
      padding: 10px; 
      overflow-y: auto; 
    }
    .error { color: red; margin-bottom: 10px; }
    .label-container { display: flex; align-items: center; margin-bottom: 5px; }
    .label-checkbox { margin-right: 10px; }
    .label-color-swatch { 
      width: 20px; 
      height: 20px; 
      border-radius: 3px; 
      margin-right: 10px; 
    }
    .label-name { color: #000; }
    .section { 
      margin-bottom: 15px; 
    }
    #members {
      width: 100%;
      height: 120px; 
      margin-bottom: 15px;
    }
    .help-text {
      font-size: 12px;
      color: #5e6c84;
      margin-bottom: 10px;
    }
    #dueDate {
      width: 100%;
      margin-bottom: 10px;
    }
    #createButton {
      width: 100%;
    }
    .label-date-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .label-container {
      flex: 1;
      display: flex;
      align-items: center;
    }
    .date-input {
      margin-left: 10px;
      width: 130px;
    }
  </style>
</head>
<body>
  <div id="error" class="error"></div>
  <div id="content">
    <div class="section">
      <h3>Labels and Due Dates</h3>
      <div id="labels-and-dates"></div>
    </div>
    <div class="section">
      <h3>Members</h3>
      <select id="members" multiple>
        <!-- Options will be populated dynamically -->
      </select>
      <div class="help-text">
        Hold Ctrl (Windows) or Cmd (Mac) to select multiple members.
        Click and drag or use Shift+Click to select a range.
      </div>
    </div>
    <button id="createButton" class="mod-primary">Create Sprint Cards</button>
  </div>
  <script>
    var TRELLO_APP_KEY = '18f0d2661292b35d137bdaa4013eb249';
    var t = window.TrelloPowerUp.iframe({
      appKey: TRELLO_APP_KEY,
      appName: 'Sprint Cards Power-Up'
    });

    function getLabelColor(color) {
      const colors = {
        'yellow': '#f2d600',
        'purple': '#c377e0',
        'blue': '#0079bf',
        'red': '#eb5a46',
        'green': '#61bd4f',
        'orange': '#ff9f1a',
        'black': '#344563',
        'sky': '#00c2e0',
        'pink': '#ff78cb',
        'lime': '#51e898',
        'yellow_dark': '#d9b51c',
        'purple_dark': '#89609e',
        'blue_dark': '#055a8c',
        'red_dark': '#b04632',
        'green_dark': '#519839',
        'orange_dark': '#d29034',
        'black_dark': '#091e42',
        'sky_dark': '#0098b7',
        'pink_dark': '#c75188',
        'lime_dark': '#4bbf6b',
        'yellow_light': '#f5ea92',
        'purple_light': '#dfc0eb',
        'blue_light': '#8bbdd9',
        'red_light': '#ef7564',
        'green_light': '#90d5b5',
        'orange_light': '#fdc788',
        'black_light': '#b3bac5',
        'sky_light': '#9de0ed',
        'pink_light': '#ffa7d3',
        'lime_light': '#b7f2d8'
      };
      return colors[color] || color;
    }

    function populateLabels() {
      return t.card('labels')
        .then(function(card) {
          var labelsAndDatesContainer = document.getElementById('labels-and-dates');
          labelsAndDatesContainer.innerHTML = '';
          card.labels.forEach(function(label) {
            var labelDateContainer = document.createElement('div');
            labelDateContainer.className = 'label-date-container';
            
            var labelContainer = document.createElement('div');
            labelContainer.className = 'label-container';
            
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = label.id;
            checkbox.className = 'label-checkbox';
            
            var colorSwatch = document.createElement('div');
            colorSwatch.className = 'label-color-swatch';
            colorSwatch.style.backgroundColor = getLabelColor(label.color) || '#c4c9cc'; // Default to grey if color is undefined
            
            var labelName = document.createElement('span');
            labelName.className = 'label-name';
            labelName.textContent = label.name || label.color || 'Unnamed';
            
            labelContainer.appendChild(checkbox);
            labelContainer.appendChild(colorSwatch);
            labelContainer.appendChild(labelName);
            
            var dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'date-input';
            dateInput.dataset.labelId = label.id;
            
            labelDateContainer.appendChild(labelContainer);
            labelDateContainer.appendChild(dateInput);
            labelsAndDatesContainer.appendChild(labelDateContainer);
          });
        });
    }

    function populateMembers() {
      return t.board('members')
        .then(function(board) {
          var membersSelect = document.getElementById('members');
          membersSelect.innerHTML = '';
          board.members.forEach(function(member) {
            var option = document.createElement('option');
            option.value = member.id;
            option.textContent = member.fullName;
            membersSelect.appendChild(option);
          });
        });
    }

    function findSprintBoard() {
      return t.organization('id')
        .then(function(organization) {
          return t.getRestApi().getToken()
            .then(function(token) {
              return fetch(`https://api.trello.com/1/organizations/${organization.id}/boards?filter=open&fields=name,id&key=${TRELLO_APP_KEY}&token=${token}`)
                .then(response => response.json())
                .then(boards => {
                  console.log('All boards:', boards);
                  const sprintBoard = boards.find(board => board.name === "Sprint");
                  if (sprintBoard) {
                    console.log('Found Sprint board:', sprintBoard);
                    return sprintBoard;
                  } else {
                    console.error('Sprint board not found');
                    throw new Error('Sprint board not found');
                  }
                });
            });
        });
    }

    function findBacklogList(boardId) {
      return t.getRestApi().getToken()
        .then(function(token) {
          return fetch(`https://api.trello.com/1/boards/${boardId}/lists?fields=name,id&key=${TRELLO_APP_KEY}&token=${token}`)
            .then(response => response.json())
            .then(lists => {
              console.log('All lists in Sprint board:', lists);
              const backlogList = lists.find(list => list.name === "Backlog");
              if (backlogList) {
                console.log('Found Backlog list:', backlogList);
                return backlogList;
              } else {
                console.error('Backlog list not found');
                throw new Error('Backlog list not found');
              }
            });
        });
    }

    document.getElementById('createButton').addEventListener('click', function() {
      var selectedLabels = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(checkbox => ({
          id: checkbox.value,
          dueDate: document.querySelector(`.date-input[data-label-id="${checkbox.value}"]`).value
        }));
      var selectedMembers = Array.from(document.getElementById('members').selectedOptions)
        .map(option => option.value);

      console.log('Selected labels:', selectedLabels);
      console.log('Selected members:', selectedMembers);

      this.disabled = true;
      this.textContent = 'Creating Cards...';

      findSprintBoard()
        .then(sprintBoard => findBacklogList(sprintBoard.id))
        .then(backlogList => {
          console.log('Ready to create cards in Backlog list:', backlogList);
          
          return t.card('all')
            .then(sourceCard => {
              console.log('Source card:', sourceCard);
              var createPromises = selectedLabels.map(function(labelData) {
                var label = sourceCard.labels.find(l => l.id === labelData.id);
                console.log('Creating card for label:', label);
                var newCardName = `${sourceCard.name}: ${label.name || label.color}`;
                var dueDate = null;
                if (labelData.dueDate) {
                  var [year, month, day] = labelData.dueDate.split('-').map(Number);
                  var date = new Date(year, month - 1, day, 17, 0, 0, 0);  // month is 0-indexed
                  dueDate = date.toISOString();
                }
                
                return t.getRestApi().getToken()
                  .then(token => {
                    console.log('Creating card with data:', {
                      name: newCardName,
                      desc: sourceCard.desc,
                      due: dueDate,
                      idList: backlogList.id,
                      idMembers: selectedMembers,
                      idLabels: [labelData.id]
                    });
                    return fetch(`https://api.trello.com/1/cards?key=${TRELLO_APP_KEY}&token=${token}`, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        name: newCardName,
                        desc: sourceCard.desc,
                        pos: 'top',
                        due: dueDate,
                        idList: backlogList.id,
                        idMembers: selectedMembers,
                        idLabels: [labelData.id]
                      })
                    })
                    .then(response => {
                      if (!response.ok) {
                        return response.text().then(text => {
                          console.error('Error response:', text);
                          throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                        });
                      }
                      return response.json();
                    })
                    .then(newCard => {
                      console.log('New card created:', newCard);
                      // Add source card as attachment to new card
                      return fetch(`https://api.trello.com/1/cards/${newCard.id}/attachments?key=${TRELLO_APP_KEY}&token=${token}`, {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                          name: `Source: ${sourceCard.name}`,
                          url: `https://trello.com/c/${sourceCard.shortLink}`
                        })
                      }).then(() => newCard);
                    });
                  });
              });

              return Promise.all(createPromises);
            });
        })
        .then(newCards => {
          console.log('Created cards:', newCards);
          t.closePopup();
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('error').textContent = 'Error creating cards. Please try again.';
        })
        .finally(() => {
          this.disabled = false;
          this.textContent = 'Create Sprint Cards';
        });
    });

    // Initialize
    Promise.all([populateLabels(), populateMembers()])
      .then(() => console.log('Initialization complete'))
      .catch(error => console.error('Initialization failed:', error));
  </script>
</body>
</html>
